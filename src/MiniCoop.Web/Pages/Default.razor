@page "/{App}"
@page "/{App}/{Page}"
@using System.Reflection
@using MiniCoop.Web.State
@inject AppState AppState
@inject NavigationManager Nav

@if (ComponentType != null)
{
    <DynamicComponent Type="ComponentType" />
}

@code {
    [Parameter] public string? App { get; set; }
    [Parameter] public string? Page { get; set; }

    private Type? ComponentType;

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrWhiteSpace(App))
        {
            AppState.SetApp(App);
        }

        if (string.IsNullOrWhiteSpace(AppState.CurrentApp))
        {
            Nav.NavigateTo("/", true);
            return;
        }

        if (string.IsNullOrWhiteSpace(Page))
        {
            ComponentType = null;
            return;
        }

        ComponentType = ResolveComponent(App!, Page!);
    }

    private Type? ResolveComponent(string app, string page)
    {
        var assembly = Assembly.GetExecutingAssembly();

        var appName = char.ToUpper(app[0]) + app.Substring(1);
        var pageName = char.ToUpper(page[0]) + page.Substring(1);

        var fullName = $"MiniCoop.Web.Pages.Applications.{appName}.{pageName}";

        return assembly.GetType(fullName);
    }
}